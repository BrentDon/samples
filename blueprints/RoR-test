#    This is a sample blueprint that deploys a ruby on rails (ror) web app with RDS PostgreSQL database.
#    https://community.qtorque.io/developing-blueprints-61/the-blueprint-yaml-file-307
#
---
spec_version: 1
kind: blueprint

metadata: 
  description: >
    Ruby on Rails application running on EKS cluster with AWS RDS (PostgreSQL)
clouds:
  - aws-demo/eks-demo

inputs:
  - version:
      description: that will be used as the docker images tag
      default_value: latest
      optional: true
  - DB_USER: root  # Used to define the db admin account
  - DB_PASS:   # Used to define the db admin password
      display_style: masked
      description: please set the root database password
      default_value: Torque!123
  - DB_NAME: demo_db  # DB_NAME - a target database name
      
applications:
  - ror-app:
      input_values:
        - DOCKER_TAG: $version
        - REDIS: ${torque.services.elasticache-postgres-modules.outputs.hostname}
        - POSTGRES: ${torque.services.elasticache-postgres-modules.outputs.postgres_hostname}
        - DB_NAME: $DB_NAME
        - DB_USER: $DB_USER
        - DB_PASS: $DB_PASS

ingress:
  listeners:
    - http: 80
      rules:
      - application: ror-app
        port: 3000
        default: true
        shortcut: ${torque.environment.public_address}
        health_check:                  
          interval: 40
          path: /
          status-codes: 200-299
          timeout: 200
          unhealthy-threshold: 5
